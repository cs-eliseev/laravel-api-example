<?php

declare(strict_types=1);

namespace Tests\SearchService;

use App\Components\FilterQuery\FilterQuery;
use App\Filters\ClientFilterQuery;
use App\Models\Client;
use App\Services\ClientService\ClientService;
use App\Services\ClientService\Models\ClientServiceDto;
use App\Services\ClientService\Models\ClientServiceEmailsDto;
use App\Services\ClientService\Models\ClientServicePhonesDto;
use App\Components\FilterQuery\Models\FilterQueryDto;
use Faker\Factory;
use Illuminate\Foundation\Testing\DatabaseTransactions;
use Tests\TestCase;

final class SearchServiceTest extends TestCase
{
    use DatabaseTransactions;

    /**
     * @var ClientService $clientService
     */
    private ClientService $clientService;

    /**
     * @var FilterQuery $searchService
     */
    private FilterQuery $searchService;

    /**
     * @var array $input
     */
    private array $input;

    /**
     * @var bool $isInit
     */
    private bool $isInit = true;

    protected function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        if ($this->isInit) {
            $this->searchService = new FilterQuery();
            $this->clientService = new ClientService();
            $this->isInit = false;
        }
    }

    /**
     * @test
     */
    public function testNotFound(): void
    {
        $input = $this->generateInputData();

        $collection = $this->searchService->run(new FilterQueryDto(
            Client::query(),
            ClientFilterQuery::class,
            [
                'first_name' => $input['first_name'],
                'last_name' => $input['last_name'],
            ]
        ));
        $this->assertEquals(0, $collection->count());
    }

    /**
     * * @test
     *
     * @dataProvider searchDataProvider
     *
     * @param $builder
     * @param array $input
     * @param array $search
     */
    public function testSearchData($builder, array $input, array $search): void
    {
        $dtoCreate = new ClientServiceDto(
            $input['first_name'],
            $input['last_name'],
            new ClientServiceEmailsDto($input['emails']),
            new ClientServicePhonesDto($input['phones'])
        );

        $this->clientService->create($dtoCreate);
        $this->clientService->create($dtoCreate);

        $searchService = new FilterQuery();
        $collection = $searchService->run(new FilterQueryDto($builder, ClientFilterQuery::class, $search));
        $this->assertEquals(2, $collection->count());

        $collection->each(function ($client) use ($dtoCreate) {
            $this->assertEquals($client, $dtoCreate->toArray());
        });
    }

    /**
     * @return array
     */
    public function searchDataProvider(): array
    {
        $firstNameData = $this->fakerInputData();
        $lastNameData = $this->fakerInputData();
        $emailsData = $this->fakerInputData();
        $phonesData = $this->fakerInputData();
        $allData = $this->fakerInputData();

        return [
            [
                Client::class,
                $firstNameData,
                [
                    'first_name' => $firstNameData['first_name'],
                    'last_name' => null,
                    'email' => null,
                    'phone' => null,
                ]
            ],
            [
                new Client(),
                $lastNameData,
                [
                    'first_name' => null,
                    'last_name' => $lastNameData['last_name'],
                    'email' => null,
                    'phone' => null,
                ]
            ],
            [
                Client::class,
                $emailsData,
                [
                    'first_name' => null,
                    'last_name' => null,
                    'email' => $emailsData['emails'][0],
                    'phone' => null,
                ]
            ],
            [
                new Client(),
                $phonesData,
                [
                    'first_name' => null,
                    'last_name' => null,
                    'email' => null,
                    'phone' => $phonesData['phones'][0],
                ]
            ],
            [
                Client::class,
                $allData,
                [
                    'first_name' => $allData['first_name'],
                    'last_name' => $allData['last_name'],
                    'email' => $allData['emails'][0],
                    'phone' => $allData['phones'][0],
                ]
            ],
        ];
    }

    /**
     * Проверка сущестования пользователя.
     *
     * @param array $input
     *
     * @return bool
     */
    private function checkClientExist(array $input): bool
    {
        return Client::query()->where([
            'first_name' => $input['first_name'],
            'last_name' => $input['last_name']
        ])->exists();
    }

    /**
     * Генератор тестовых данных клиента.
     *
     * @return array
     */
    private function generateInputData(): array
    {
        do {
            $input = $this->fakerInputData();
            $isNotUniq = $this->checkClientExist($input);
        } while ($isNotUniq);

        return $input;
    }

    /**
     * Тестовые данные.
     *
     * @return array
     */
    private function fakerInputData(): array
    {
        $faker = Factory::create( 'ru_RU');

        $i = $faker->numberBetween(1, 4);
        $emails = [];
        $phones = [];

        do {
            $emails[] = $faker->email;
            $phones[] = (string) $faker->numberBetween(1000000, 9999999999999999);
            $i--;
        } while ($i > 0);

        return [
            'first_name' => "{$faker->firstName}_test",
            'last_name' => "{$faker->lastName}_test",
            'emails' => $emails,
            'phones' => $phones,
        ];
    }
}
